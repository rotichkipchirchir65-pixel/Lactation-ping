<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SPARK-X Wi-Fi + Voucher Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
  <style>
    body {
      background: #0f0f0f;
      color: #00ccff;
      font-family: 'Fira Code', monospace;
      padding: 20px;
      position: relative;
      z-index: 1;
    }
    input, button {
      font-family: inherit;
      padding: 8px;
      margin: 6px 4px;
      background: #111;
      color: #00ccff;
      border: 1px solid #00ccff;
      border-radius: 4px;
    }
    #log {
      white-space: pre-wrap;
      margin-top: 20px;
      background: rgba(0, 0, 255, 0.05);
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #00ccff;
      box-shadow: 0 0 12px #00ccff, 0 0 20px #00ccff;
      color: #00ccff;
      position: relative;
      z-index: 1;
    }
    canvas#matrix {
      position: fixed;
      top: 0;
      left: 0;
      z-index: -1;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <canvas id="matrix"></canvas>

  <h1>üì° SPARK-X Wi-Fi + Voucher Tracker</h1>

  <h3>üîê Voucher Activation</h3>
  <input type="text" id="voucher" placeholder="Enter new voucher code">
  <button onclick="addVoucher()">Activate Voucher</button>
  <button onclick="clearVouchers()">Clear Vouchers</button>

  <h3>‚è± Extend Session</h3>
  <button onclick="extendSession(30)">Extend +30 min</button>
  <button onclick="extendSession(60)">Extend +1 hour</button>

  <div id="log">Initializing...</div>

  <script>
    let session = {};
    let countdownInterval;
    let vouchers = JSON.parse(localStorage.getItem("vouchers") || "[]");

    function detectVoucherFromURL() {
      const url = window.location.href;
      const match = url.match(/@([A-Z0-9]+)_/);
      if (match) {
        const code = match[1];
        const now = new Date();
        const entry = { code, activatedAt: now.toISOString(), loginURL: url };
        vouchers.push(entry);
        localStorage.setItem("vouchers", JSON.stringify(vouchers));
      }
    }

    function autoStartSession() {
      session = {
        startTime: new Date(),
        durationMinutes: 60,
        endTime: new Date(Date.now() + 60 * 60 * 1000),
        expired: false,
        device: {
          userAgent: navigator.userAgent,
          language: navigator.language,
          platform: navigator.platform,
          screen: {
            width: screen.width,
            height: screen.height,
            orientation: screen.orientation?.type || "unknown"
          },
          connection: navigator.connection?.type || "unknown"
        },
        ip: "pending",
        location: "pending"
      };

      fetch("https://api.ipify.org?format=json")
        .then(res => res.json())
        .then(data => { session.ip = data.ip; updateLog(); })
        .catch(() => { session.ip = "lookup failed"; updateLog(); });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`);
            const data = await res.json();
            const addr = data.address || {};
            session.location = {
              latitude: lat,
              longitude: lon,
              country: addr.country || "Unknown",
              county: addr.county || "Unknown",
              division: addr.state_district || addr.state || "Unknown",
              subcounty: addr.subcounty || "Unknown",
              ward: addr.suburb || addr.ward || "Unknown",
              village: addr.village || addr.hamlet || "Unknown",
              road: addr.road || "Unknown",
              house: addr.house_number || "Unknown",
              fullAddress: data.display_name || "Unknown"
            };
            updateLog();
          } catch {
            session.location = { latitude: lat, longitude: lon, error: "lookup failed" };
            updateLog();
          }
        }, err => {
          session.location = "location error: " + err.message;
          updateLog();
        });
      }

      startCountdown();
      updateLog();
    }

    function extendSession(minutes) {
      if (session.expired) return;
      session.durationMinutes += minutes;
      session.endTime = new Date(session.endTime.getTime() + minutes * 60 * 1000);
      updateLog();
    }

    function startCountdown() {
      clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        const now = new Date();
        const remaining = session.endTime - now;
        if (remaining <= 0) {
          session.expired = true;
          clearInterval(countdownInterval);
        }
        updateLog();
      }, 1000);
    }

    function formatTime(ms) {
      if (ms <= 0) return "00:00:00";
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
    }
    function pad(n) { return n < 10 ? "0" + n : n; }

    function addVoucher() {
      const code = document.getElementById("voucher").value.trim().toUpperCase();
      if (!code) return;
      const now = new Date();
      const entry = { code, activatedAt: now.toISOString(), loginURL: `http://clince.net/login.html?@${code}_` };
      vouchers.push(entry);
      localStorage.setItem("vouchers", JSON.stringify(vouchers));
      document.getElementById("voucher").value = "";
      updateLog();
      window.open(entry.loginURL, "_blank");
    }

    function clearVouchers() {
      if (confirm("Clear all voucher logs?")) {
        vouchers = [];
        localStorage.removeItem("vouchers");
        updateLog();
      }
    }

    function updateLog() {
      const now = new Date();
      const sessionRemaining = session.endTime ? session.endTime - now : 0;
      const sessionLog = session.startTime ? {
        startTime: session.startTime.toISOString(),
        endTime: session.endTime.toISOString(),
        durationMinutes: session.durationMinutes,
        timeRemaining: formatTime(sessionRemaining),
        expired: session.expired,
        ip: session.ip,
        location: session.location,
        device: session.device
      } : "No session started.";

      const voucherLog = vouchers.map((v, i) => {
        const activated = new Date(v.activatedAt);
        const elapsed = now - activated;
        const remaining = 24 * 60 * 60 * 1000 - elapsed;
        const expired = remaining <= 0;
        const hrsUsed = Math.floor(elapsed / 3600000);
        const minsUsed = Math.floor((elapsed % 3600000) / 60000);
        const hrsLeft = Math.max(0, Math.floor(remaining / 3600000));
        const minsLeft = Math.max(0, Math.floor((remaining % 3600000) / 60000));
        return `#${i + 1} ‚Äî ${v.code}
Activated: ${v.activatedAt}
Used:      ${hrsUsed}h ${minsUsed}m
Remaining: ${expired ? "‚ùå Expired" : `‚úÖ ~${hrsLeft}h ${minsLeft}m`}
Login:     ${v.loginURL}\n`;
      }).join("\n");

      document.getElementById("log").textContent =
        `üì∂ Session:\n${typeof sessionLog === "string" ? sessionLog : JSON.stringify(sessionLog, null, 2)}\n\nüîê Vouchers:\n${voucherLog || "No vouchers logged."}`;
    }

    detectVoucherFromURL();
    autoStartSession();

    // Matrix animation (green)
    const canvas = document.getElementById("matrix");
    const ctx = canvas.getContext("2d");
    function sizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    sizeCanvas();
    window.addEventListener("resize", sizeCanvas);

    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789„ÅÇ„ÅÑ„ÅÜ„Åà„ÅäÊº¢Â≠ó„Éá„Éº„ÇøÊú™Êù•ÂÖâÈÄü";
    const fontSize = 14;
    let drops = Array(Math.floor(canvas.width / fontSize)).fill(1);

    function drawMatrix() {
      // semi-transparent black background to create trailing effect
      ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // matrix characters in green
      ctx.fillStyle = "#00ff88";
      ctx.font = fontSize + "px monospace";

      for (let i = 0; i < drops.length; i++) {
        const text = chars[Math.floor(Math.random() * chars.length)];
        ctx.fillText(text, i * fontSize, drops[i] * fontSize);

        // reset drop randomly after it passes bottom
        if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
          drops[i] = 0;
        }
        drops[i]++;
      }
    }

    setInterval(drawMatrix, 50);
  </script>
</body>
</html>
